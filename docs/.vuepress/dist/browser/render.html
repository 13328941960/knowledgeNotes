<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>资源渲染 | 前端知识体系</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/knowledgeNotes/favicon.ico">
    <meta name="description" content="JavaScript、浏览器、网络协议、面试题等基本知识点">
    
    <link rel="preload" href="/knowledgeNotes/assets/css/0.styles.65249e03.css" as="style"><link rel="preload" href="/knowledgeNotes/assets/js/app.14d4cd03.js" as="script"><link rel="preload" href="/knowledgeNotes/assets/js/2.5cec4d22.js" as="script"><link rel="preload" href="/knowledgeNotes/assets/js/9.b1103298.js" as="script"><link rel="prefetch" href="/knowledgeNotes/assets/js/10.5274ef46.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/11.73dd9e06.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/12.cdc81342.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/13.fabf43ff.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/14.db14e0b9.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/15.00007a22.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/16.cde7c6c6.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/17.34b87fcb.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/18.9d50af36.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/19.5051c26d.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/20.ceec1fd2.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/21.acb4fe7b.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/22.83666e0e.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/23.eb41818b.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/24.7cade035.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/25.c8e7731a.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/26.06d3f188.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/27.2e7e125b.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/28.05c448a5.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/29.1f4450fb.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/3.3417d94e.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/30.c63596c2.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/31.0c077f18.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/32.8e4fd91f.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/33.19cf8557.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/34.349714dd.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/35.5d08661f.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/36.5b4ae026.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/37.9f2526a4.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/38.bb525eb1.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/39.9b776747.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/4.084eb4c2.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/40.62404409.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/41.ad846125.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/42.edfb6147.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/43.c5f1eb69.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/44.585b5428.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/5.9ecf4c9f.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/6.218adc9e.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/7.143c8e6f.js"><link rel="prefetch" href="/knowledgeNotes/assets/js/8.6c2bf3bc.js">
    <link rel="stylesheet" href="/knowledgeNotes/assets/css/0.styles.65249e03.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledgeNotes/" class="home-link router-link-active"><!----> <span class="site-name">前端知识体系</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledgeNotes/browser/storage.html" class="sidebar-link">本地存储</a></li><li><a href="/knowledgeNotes/browser/netWork.html" class="sidebar-link">网络请求</a></li><li><a href="/knowledgeNotes/browser/parse.html" class="sidebar-link">资源解析</a></li><li><a href="/knowledgeNotes/browser/render.html" aria-current="page" class="active sidebar-link">资源渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledgeNotes/browser/render.html#构建图层树" class="sidebar-link">构建图层树</a></li><li class="sidebar-sub-header"><a href="/knowledgeNotes/browser/render.html#生成绘制列表" class="sidebar-link">生成绘制列表</a></li><li class="sidebar-sub-header"><a href="/knowledgeNotes/browser/render.html#生成图块和位图" class="sidebar-link">生成图块和位图</a></li><li class="sidebar-sub-header"><a href="/knowledgeNotes/browser/render.html#显示器显示" class="sidebar-link">显示器显示</a></li></ul></li><li><a href="/knowledgeNotes/browser/backflow.html" class="sidebar-link">回流与重绘</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架与库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="资源渲染"><a href="#资源渲染" class="header-anchor">#</a> 资源渲染</h1> <p>渲染过程包括四个步骤：</p> <ol><li>构建图层树</li> <li>生成<code>绘制列表</code></li> <li>生成<code>图块</code> 和 <code>栅格化</code></li> <li>显示到显示器</li></ol> <h2 id="构建图层树"><a href="#构建图层树" class="header-anchor">#</a> 构建图层树</h2> <p>前面已经生成，DOM树和样式以及位置，那么是否可以直接开始渲染了呢？如果你觉得可以，那么你就错了。</p> <p>思考一下：一个3D动画怎么来呈现出变化效果呢？当含有叠层上下文时，如何控制显示和隐藏呢？</p> <p>为了解决上述的问题，浏览器在生成布局树后，还会对特点的节点进行分层，构建一棵<code>图层树</code>。</p> <p>节点的图层会默认属于父节点的图层。节点还有可能会提升为单独的合成层。
有两种情况：</p> <ol><li>显示合成</li></ol> <p>显示合成的情况：</p> <p>一、拥有<code>叠层上下文</code>的节点。</p> <p>层叠上下文也基本上是有一些特定的CSS属性创建的，一般有以下情况:</p> <ol><li>HTML根元素本身就具有层叠上下文。</li> <li>普通元素设置position不为static并且设置了z-index属性，会产生层叠上下文。</li> <li>元素的 opacity 值不是 1</li> <li>元素的 transform 值不是 none</li> <li>元素的 filter 值不是 none</li> <li>元素的 isolation 值是isolate</li> <li>will-change指定的属性值为上面任意一个。(will-change的作用后面会详细介绍)
二、需要剪裁的地方。</li></ol> <p>比如一个div，你只给他设置 100 * 100 像素的大小，而你在里面放了非常多的文字，那么超出的文字部分就需要被剪裁。
当然如果出现了滚动条，那么滚动条会被单独提升为一个图层。</p> <ol start="2"><li>隐式合成
<code>隐式合成</code>，一个节点被提升为一个单独的图层后，所有比它层叠等级高的节点都会成为一个单独的图层。</li></ol> <p>这个隐式合成其实隐藏着巨大的风险，如果在一个大型应用中，当一个z-index比较低的元素被提升为单独图层之后，层叠在它上面的的元素统统都会被提升为单独的图层，可能会增加上千个图层，大大增加内存的压力，甚至直接让页面崩溃。</p> <h2 id="生成绘制列表"><a href="#生成绘制列表" class="header-anchor">#</a> 生成绘制列表</h2> <p>接下来，渲染引擎会将图层绘制拆分成一个个绘制指令，比如说：先画背景图，再画边框...然后将这些绘制指令组合成一个绘制列表，为后面的绘制操作做好安排。</p> <p>拿百度首页来说，打开百度首页，再开打控制台，点击more tools里的Layers，就可以看到下面的绘制列表：</p> <p><img src="/knowledgeNotes/assets/img/6C383C12-6A46-4080-B2C0-B8AD2CCA838C.b9c4afba.png" alt="An image"></p> <h2 id="生成图块和位图"><a href="#生成图块和位图" class="header-anchor">#</a> 生成图块和位图</h2> <p>接着就是绘制操作，有一个专门独立负责绘制的线程，叫作合成线程。绘制列表准备好后，渲染引擎会让主线程给合成线程<code>commit</code>一个消息。
把绘制列表发送给合成线程。接着合成线程就开始进行操作。</p> <p>首先，我们考虑一个问题，视口就这么大如果加载一个很大的页面，如果一次性加载出来将非常浪费性能的。此时合成线程要做的第一件事就是
将绘制列表分块。这些块一般的规格为：256<em>256，512</em>512，这样就大大提升了页面的加载速度。</p> <p>因为后面的图块要进入GPU，考虑到浏览器内存上传到GPU的操作比较慢，即使是绘制一小块图块也是相当耗时的。所以chorme采用了一个优化：
在首次加载时，使用低分辨率的图片，这时候继续合成，当正常的图块加载出来后再替换掉。</p> <p>渲染进程中专门维护了一个<strong>栅格化线程池</strong>，用于将图块转成位图数据。</p> <p>合成线程会选择视口附近的图块交给栅格化线程池。</p> <p>生成位图的过程实际上都会使用GPU进行加速，生成的位图最后发送给合成线程。</p> <h2 id="显示器显示"><a href="#显示器显示" class="header-anchor">#</a> 显示器显示</h2> <p>合成线程生成绘制指令后，会发送给浏览器进程。浏览器进程中的viz组件接收到这个指令后，根据这个指令生成页面内容并存到内存中，也就是生成了页面。
然后将这个页面发送给显卡？为什么要发送给显卡，这时候就要讲一下显卡的显示原理了。</p> <p>不管时PC还是手机屏幕，都有一个固定的刷新频率即60HZ，也就是一秒刷新60张图片，也就是说一张图片显示大约16.67ms。
而每次更新的图片都是来自显卡的前缓冲区。显卡在接收到浏览器进程传来的内容后，会合成相应的图像存在后缓冲区。
然后，系统自动将<code>前缓冲区</code>和<code>后缓冲区</code>对换位置，如此循环更新。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/knowledgeNotes/browser/parse.html" class="prev">
          资源解析
        </a></span> <span class="next"><a href="/knowledgeNotes/browser/backflow.html">
          回流与重绘
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledgeNotes/assets/js/app.14d4cd03.js" defer></script><script src="/knowledgeNotes/assets/js/2.5cec4d22.js" defer></script><script src="/knowledgeNotes/assets/js/9.b1103298.js" defer></script>
  </body>
</html>
